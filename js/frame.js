const fetchJSON=e=>new Promise((t,n)=>{fetch(e+'.json').then(e=>e.json()).then(e=>t(e)).catch(e=>n(e))});let WS,initBackground=()=>new Promise((e,t)=>{let n=new Image;n.src='//cdn.jsdelivr.net/gh/iwfasf/frame@g60ve/img/bg.jpg',n.onload=()=>{const t=$('bg').getContext('2d');t.drawImage(n,0,0),t.translate(32,32),t.canvas.style.background='none',e()},n.onerror=t}),timer=null,url=new URL(location.href);const FRAME=url.searchParams.get('frame')||'solo',SIDE=url.searchParams.get('side')||'bilibili';Promise.all([fetchJSON('//cdn.jsdelivr.net/gh/iwfasf/frame@g60ve/template/'+FRAME),initBackground()]).then(([e])=>{WS=io.connect(location.origin+'/frame?side='+SIDE);const t=(e,t)=>WS.emit('data',{room:'control',field:e,data:t});WS.on('connect',()=>t('f.init',FRAME)),WS.on('frame',e=>{if(e===FRAME)return t('f.init',FRAME);location.search=`?frame=${e}&side=${SIDE}`});const n=$('wrap'),a=Element('div');a.id='head',css(a,{backgroundImage:'url(//cdn.jsdelivr.net/gh/iwfasf/frame@g60ve/img/'+e.head+')',backgroundPosition:e.headAlign,top:e.headTop}),n.append(a);const s=Element('div');s.id='info',css(s,e.info);let i=Element('span').txt('时间表 > iwfasf.com'),o=[Element('span','time'),Element('span','time'),Element('span').txt(':'),Element('span','time'),Element('span','time')];s.append(i),e.info&&e.info.textAlign&&!e.info.zoom?s.append(Element('br')):i.style.marginRight='32px';const l=e=>{let t=new Date,n=t.toTimeString();for(let t=0;t<5;t++)2!==t&&e[t].txt(n[t]);setTimeout(l,6e4*(1+(t.getTime()/6e4<<0))-t.getTime(),e)};l(o),s.append(...o),n.append(s),e.window.forEach((e,t)=>{let n=LiveWindow(e);n&&WS.on('f.run',e=>{e[t]&&n.txt(e[t])})});let r=[];WS.on('f.cover',e=>{e.split(',').forEach((e,t)=>{r[t]&&(r[t].style.backgroundImage=`url(//cdn.jsdelivr.net/gh/iwfasf/frame@g60ve/img/${e})`)})}),e.frame.forEach(e=>{const t=Element('div','frame');css(t,{left:e.x+'px',top:e.y+'px',width:e.w+'px',textAlign:e.align}),n.append(t),e.ui.forEach(e=>{switch(e.type){case"cover":let n=Element('div','cover box');css(n,e.style),t.append(n),r.push(n);break;case"timer":timer=new Timer(t),timer.timerBox.className+=' box',css(timer.timerBox,e.style),WS.on('timer',e=>timer[e[0]](e[1]));break;case"game":let a=Element('p');css(a,e.style),t.append(a),WS.on('f.game',e=>a.txt(e));break;case"est":let s=Element('p'),i=Element('span','cat'),o=Element('span');s.append(i,o),css(s,e.style),t.append(s),WS.on('f.cat',e=>i.txt(e)),WS.on('f.est',e=>{o.txt(' - '+Time.formatMin(e)),timer.setDuration(e)});break;case'runner':let l=Element('p');t.append(l),WS.on('f.run',e=>{l.innerHTML='<span style="font-size:28px">by</span> '+e.join(', '),l.offsetTop>t.offsetHeight&&css(l,{display:'inline-block',marginLeft:'32px'})});break;case'next':let m=Element('div','next');css(m,e.style),t.append(m),WS.on('f.next',e=>{if(e){css(m,{display:'block',fontSize:''}),m.txt(e);let n=m.offsetWidth,a=t.offsetWidth;n>a&&(m.style.fontSize=a/n*24+'px')}else m.style.display='none'});break;case'relay':t.append(Relay());break;case'danmaku':let c=Danmaku();css(c,e.style),t.append(c)}})})});