const fetchJSON=e=>new Promise((t,n)=>{fetch(e+'.json').then(e=>e.json()).then(e=>t(e)).catch(e=>n(e))});let initBackground=()=>new Promise((e,t)=>{let n=new Image;n.src='//cdn.jsdelivr.net/gh/iwfasf/frame@g5vad/img/bg.jpg',n.onload=()=>{const t=$('bg').getContext('2d');t.drawImage(n,0,0),t.translate(32,32),t.canvas.style.background='none',e()},n.onerror=t}),url=new URL(location.href);const FRAME=url.searchParams.get('frame')||'solo',SIDE=url.searchParams.get('side')||'bilibili';Promise.all([fetchJSON('//cdn.jsdelivr.net/gh/iwfasf/frame@g5vad/template/'+FRAME),initBackground()]).then(([e])=>{const t=io.connect(location.origin+'/frame?side='+SIDE),n=(e,n)=>t.emit('data',{room:'control',field:e,data:n});t.on('connect',()=>n('f.init',FRAME)),t.on('frame',e=>{if(e===FRAME)return n('f.init',FRAME);location.search=`?frame=${e}&side=${SIDE}`});const a=$('wrap'),s=Element('div');s.id='head',css(s,{backgroundImage:'url(//cdn.jsdelivr.net/gh/iwfasf/frame@g5vad/img/'+e.head+')',backgroundPosition:e.headAlign,top:e.headTop}),a.append(s);const o=Element('div');o.id='info',css(o,e.info);let i=Element('span').txt('时间表 > iwfasf.com'),l=[Element('span','time'),Element('span','time'),Element('span').txt(':'),Element('span','time'),Element('span','time')];o.append(i),e.info&&e.info.textAlign&&!e.info.zoom?o.append(Element('br')):i.style.marginRight='32px';const r=e=>{let t=new Date,n=t.toTimeString();for(let t=0;t<5;t++)2!==t&&e[t].txt(n[t]);setTimeout(r,6e4*(1+(t.getTime()/6e4<<0))-t.getTime(),e)};r(l),o.append(...l),a.append(o),e.window.forEach((e,n)=>{let a=LiveWindow(e);a&&t.on('f.run',e=>{e[n]&&a.txt(e[n])})});let c=null,m=[];t.on('f.cover',e=>{e.split(',').forEach((e,t)=>{m[t]&&(m[t].style.backgroundImage=`url(//cdn.jsdelivr.net/gh/iwfasf/frame@g5vad/img/${e})`)})}),e.frame.forEach(e=>{const n=Element('div','frame');css(n,{left:e.x+'px',top:e.y+'px',width:e.w+'px',textAlign:e.align}),a.append(n),e.ui.forEach(e=>{switch(e.type){case"cover":let a=Element('div','cover box');css(a,e.style),n.append(a),m.push(a);break;case"timer":c=new Timer(n),c.timerBox.className+=' box',css(c.timerBox,e.style),t.on('timer',e=>c[e[0]](e[1]));break;case"game":let s=Element('p');css(s,e.style),n.append(s),t.on('f.game',e=>s.txt(e));break;case"est":let o=Element('p'),i=Element('span','cat'),l=Element('span');o.append(i,l),css(o,e.style),n.append(o),t.on('f.cat',e=>i.txt(e)),t.on('f.est',e=>{l.txt(' - '+Time.formatMin(e)),c.setDuration(e)});break;case'runner':let r=Element('p');n.append(r),t.on('f.run',e=>{r.innerHTML='<span style="font-size:28px">by</span> '+e.join(', '),r.offsetTop>n.offsetHeight&&css(r,{display:'inline-block',marginLeft:'32px'})});break;case'next':let p=Element('div','next');css(p,e.style),n.append(p),t.on('f.next',e=>{if(e){css(p,{display:'block',fontSize:''}),p.txt(e);let t=p.offsetWidth,a=n.offsetWidth;t>a&&(p.style.fontSize=a/t*24+'px')}else p.style.display='none'});break;case'relay':n.append(Relay());break;case'danmaku':let d=Danmaku();css(d,e.style),n.append(d)}})})});