const Score=()=>{let t=Element('div','box',{id:'score'});for(let e=1;e<6;e++)t.ap(Element('div').ap(Element('div','par').txt(e),Element('span'),Element('div','fr')));return t},Stat=()=>{let t=Element('div','box',{id:'stat'});for(let e=0;e<4;e++)t.ap(Element('div').ap(Element('div','tri').txt('ABCD'[e]),Element('div','bar'),Element('div','fr')));return t},Count=()=>{let t=Element('div','box',{id:'count'});return t.ap(Element('div'),Element('div')),t},QAF=(t,e,n)=>{let a=Element('div','QA');return a.ap(Element('div',0,{id:'t-iw'}).txt(t),Element('div',0,{id:'t-qa'}).txt(e),Element('div',0,{id:'rule'}).ap(Element('span').txt(n),Element('b').txt('发送弹幕即可参与答题，弹幕格式：题号+空格+答案 ( 示例：16 C ) ，每道题只有一次答题机会'),Element('span').txt('，弹幕有延迟，答题要快哦！')),Element('div','box',{id:'listL'}),Element('div','box',{id:'listR'}),Element('div',0,{id:'opt'}).ap(Element('div').ap(Element('div','par').txt('A'),Element('span')),Element('div').ap(Element('div','par').txt('B'),Element('span')),Element('div').ap(Element('div','par').txt('C'),Element('span')),Element('div').ap(Element('div','par').txt('D'),Element('span')))),a},QAFrame=()=>{let t=QAF('I Wanna','Q & A','FASF 的 I Wanna 考试来了！这里有60道与 I Wanna 相关的题目，包含IW的各种知识和各种梗。');t.id='qa';let e=Element('div','box',{id:'qu'}).ap(Element('div','tag'),Element('p'),Element('p'));t.ap(e),fetchJSON('data/qa/q').then(t=>QA=t);let n,[a,s,i]=e.children;return qaTo=async t=>{if(void 0===t?t=now+1:-1===t&&(t=now-1),!QA[t])return;QAEnd=!1,css([$('listL'),$('listR')],{opacity:0}),snd&&snd.pause(),s.style.opacity=i.style.opacity=0;for(let t=0;t<4;t++)opt[t].style.opacity=0,stat[t].clear();ct[0].txt(`当前参与：0/${score.length}`);for(let t of score)t.a='';count.A=count.B=count.C=count.D=0,await wait(350),a.txt(`Q.${t+1}`),now=t,localStorage.setItem(location.pathname,now);let o=QA[t],r=[o.A,o.B,o.C,o.D],l=e.style.height;e.style.height='',s.txt(o.cn),i.txt(o.en),n&&n.remove(),o.img&&(n=new Image,n.src='data/qa/'+o.img,s.prepend(n));let c=e.offsetHeight+'px';e.style.height=l,await wait(20),e.style.height=c;for(let t=0;t<4;t++)opt[t].style.transform='translateX(-40px)',opt[t].lastChild.innerHTML=r[t],opt[t].className='';await wait(400),s.style.opacity=i.style.opacity=1;for(let t=0;t<4;t++)opt[t].style.opacity='',opt[t].style.transform='',await wait(100);checked=!1,o.audio&&(snd=new Audio('data/qa/'+o.audio),snd.volume=VOLUME,await wait(500),snd.play())},startAnm=async()=>{$('opt').style.opacity=1,qaTo(now),await wait(350),$('qu').style.opacity=1},hideAll=async()=>{$('opt').style.opacity=0,$('qu').style.opacity=0},t},MQFrame=()=>{let t=QAF('Fangame','♪ Music Quiz','FASF 的 I Wanna 听力测试来了！60道题目，你需要根据音乐片段选出对应的游戏。');t.id='MQ';let e=Element('div',0,{id:'mq'}).ap(Element('div',0,{id:'ring1'}),Element('div',0,{id:'ring2'}),Element('div',0,{id:'qNum'}));t.ap(e);let n=Element('div','tip').ap(Element('p').txt('请注意！接下来的10道题要求选出没有出现该音乐片段的游戏！'),Element('p').txt('Caution! The next 10 questions require you to choose a game that does NOT have the music!'));t.ap(n),fetchJSON('data/mq/q').then(t=>QA=t);let a,s,i=[],o=!1;for(let e=0;e<360;e+=10){let n=Element('div','fft');n.trans=`rotate(${e}deg)`,n.style.transform=n.trans,t.ap(n),i.push(n),n.max=128}qaTo=async t=>{if(o)return;if(void 0===t?t=now+1:-1===t&&(t=now-1),!QA[t])return;QAEnd=!1,css([$('listL'),$('listR')],{opacity:0});for(let t=0;t<4;t++)opt[t].style.opacity=0,stat[t].clear();$('qNum').txt('Q. '+(t+1)),css([$('ring1'),$('ring2')],{display:'none'}),s&&(clearTimeout(s),s=0),o=!0,a&&(a.pause(),a.snd&&(a.snd.disconnect(),a.snd=null)),await wait(400),now=t,localStorage.setItem(location.pathname,now),50===t&&(n.style.opacity=1,await wait(5e3),n.style.opacity=0,await wait(400));let e=QA[t],i=[e.A,e.B,e.C,e.D];for(let t=0;t<4;t++)opt[t].style.transform='translateX(-40px)',opt[t].lastChild.txt(i[t]),opt[t].className='';await wait(400);for(let t=0;t<4;t++)css(opt[t],{opacity:'',transform:''}),await wait(100);checked=!1,a=new Audio(`data/mq/${t+1}.mp3`),a.oncanplay=function(){this.snd=r.createMediaElementSource(a),this.snd.connect(l);let t=a.duration+5;css($('ring1'),{display:'block',animation:`ring1 linear ${t}s`}),css($('ring2'),{display:'block',animation:`ring2 linear ${t}s`}),a.play(),o=!1},a.onended=function(){this.snd.disconnect(),this.snd=null,s=setTimeout(check,5e3)},a.volume=VOLUME},startAnm=async()=>{$('opt').style.opacity=1,$('mq').style.opacity=1,qaTo(now),await wait(1e3),css(i,{display:'block'}),requestAnimationFrame(d)},hideAll=()=>{$('opt').style.opacity=0,$('mq').style.opacity=0,css(i,{display:''})};const r=new AudioContext,l=r.createAnalyser(),c=new Uint8Array(l.frequencyBinCount);function d(){l.getByteTimeDomainData(c);for(let t=0;t<36;t++){let e=c[7*t];e>i[t].max?i[t].max=e:i[t].max>128&&(i[t].max-=4*VOLUME);let n=1.5*(i[t].max-128)/VOLUME;n>128&&(n=128),i[t].style.transform=`${i[t].trans} translateY(${n}px)`}requestAnimationFrame(d)}return l.fftSize=512,l.connect(r.destination),t};let startAnm,hideAll,qaTo,snd,QA,opt=null,topScore=null,stat=null,ct=null,now=Number(localStorage.getItem(location.pathname))||0,count={A:0,B:0,C:0,D:0},checked=!1,user={},score=[],ANSWER=0,CORRECT=0,VOLUME=.5,QAEnd=!1;const QAInit=()=>{opt=$('opt').children,topScore=$('score').children,stat=$('stat').children,ct=$('count').children;for(let t=0;t<4;t++){opt[t].style.opacity=0;let e=stat[t].children;stat[t].b=e[1],stat[t].p=e[2],stat[t].set=function(t){this.b.style.width=`calc(${t}% - 64px)`,this.p.txt(t.toFixed(0)+'%')},stat[t].clear=function(){this.b.style.width=0,this.p.txt('')}}ct[0].txt('当前参与：--/--'),ct[1].txt('平均正确率：--'),WSDanmaku.on('danmaku',t=>{if(checked)return;let[e,n]=t.text.split(' ');if(e!=now+1)return;if(n=n.toUpperCase(),'A'!=n&&'B'!=n&&'C'!=n&&'D'!=n)return;if(void 0!==user[t.uid]){let e=score[user[t.uid]];if(e.n=t.name,e.a)return;e.a=n}else user[t.uid]=score.push({i:t.uid,n:t.name,s:0,a:n})-1;count[n]++;let a=(count.A+count.B+count.C+count.D)/100;stat[0].set(count.A/a),stat[1].set(count.B/a),stat[2].set(count.C/a),stat[3].set(count.D/a),ct[0].txt(`当前参与：${Math.round(100*a)}/${score.length}`)}),WS.on('vol',t=>VOLUME=t),WS.on('timer',t=>{'start'===t[0]&&qaStart(0)}),WS.on('qa',t=>{switch(t){case'answer':check();break;case'next':qaTo();break;case'prev':qaTo(-1);break;case'resume':qaStart();break;case'over':QAEnd=!0,showList();break;case'replay':snd&&snd.play();break;default:Number(t)&&qaTo(Number(t)-1)}})};async function check(){for(let t of opt)t.className=QA[now].answer.includes(t.firstChild.innerText)?'correct':'wrong';checked=!0,count.A=count.B=count.C=count.D=0;for(let t of score)t.a&&(ANSWER++,QA[now].answer.includes(t.a)&&(t.s++,CORRECT++)),t.a='';score.sort((t,e)=>e.s-t.s),await wait(1e3),showScore(),ct[1].txt(`平均正确率：${Math.round(CORRECT/ANSWER*100)}%`),DB.put('2021',{id:location.pathname,a:ANSWER,c:CORRECT,user,score})}function showScore(){for(let t=score.length;t--;)if(user[score[t].i]=t,t<5){let e=topScore[t].children;e[1].txt(score[t].n),e[2].txt(score[t].s)}}async function showList(t=0){if(!QAEnd)return;hideAll(),timer.pause();let e=$('listL');e.style.opacity=1,e.innerHTML='';for(let n=0;n<10&&score[t+n];n++){let a=e.appendChild(Element('div'));a.innerHTML=`<div class='par'>${t+n+1}</div><span></span><div class='fr'>${score[t+n].s}</div>`,a.children[1].txt(score[t+n].n)}e=$('listR'),e.style.opacity=1,e.innerHTML='';for(let n=10;n<20&&score[t+n];n++){let a=e.appendChild(Element('div'));a.innerHTML=`<div class='par'>${t+n+1}</div><span></span><div class='fr'>${score[t+n].s}</div>`,a.children[1].txt(score[t+n].n)}await wait(1e4),showList(t?0:20)}async function qaStart(t){void 0===t?DB.onready(()=>DB.get('2021',location.pathname).then(t=>{ANSWER=t.a,CORRECT=t.c,user=t.user,score=t.score,showScore()})):now=t,$('t-iw').style.transform=$('t-qa').style.transform='none',$('rule').style.opacity=0,await wait(500),startAnm()}const IDB=class{constructor(t,e,n){this.cls=Array.from(n.split(','),t=>{let e=t.split('.'),n={a:'+'===e[0][0]};return n.n=n.a?e[0].slice(1):e[0],e.length>1&&(n.k=e.slice(1)),n}),this.ready=[],this.rd=!1;let a=window.indexedDB.open(t,e);a.onerror=()=>alert('启动失败：无法打开数据库'),a.onsuccess=t=>{this.IDB=a.result,this.ready.forEach(t=>t()),this.ready=null,this.rd=!0},a.onupgradeneeded=t=>{this.IDB=a.result,this.IDB.onabort=this.IDB.onclose=this.IDB.onerror=console.log,this.cls.forEach(t=>{if(!this.IDB.objectStoreNames.contains(t.n)){let e=this.IDB.createObjectStore(t.n,{keyPath:'id',autoIncrement:t.a});t.k&&t.k.forEach(t=>e.createIndex(t,t))}})}}onready(t){this.rd?(t(),t=null):this.ready.push(t)}open(t,e){return this.IDB.transaction(t,e?'readwrite':'readonly').objectStore(t)}put(t,e){return new Promise((n,a)=>{let s=this.open(t,1).put(e);s.onsuccess=t=>n(t),s.onerror=a})}get(t,e){return new Promise((n,a)=>{let s=this.open(t).get(e);s.onsuccess=t=>s.result?n(s.result):a(t),s.onerror=a})}},DB=new IDB('FASF',2,'2021');