const WS=io.connect(location.origin+'/frame?side=control');WS.on('confirm',()=>{confirm('已有控制台正在运行，是否重新连接？')&&WS.emit('replace')});const WSFrame=[];WS.on('f.init',t=>{t!==WSFrame.frame&&WSFrame.switch?WSFrame.switch.onclick():WSFrame.forEach(t=>t.send())});const WSSend=(t,e,n,a="bilibili,twitch")=>(t.field=e,t.send=()=>{WS.emit('data',{room:a,field:e,data:t.value||n})},n||setTimeout(t=>{t.parentNode.ws||(t.parentNode.ws=[]),t.parentNode.ws.push(t)},10,t),t),WSBind=(t,e,n,a,l="bilibili,twitch")=>WSSend(bindUpd(Element('span'),t,e,(t,e)=>{t.value=n?n(e):e,t.txt(t.value),t.send&&t.send()}),a,0,l),Switch=(t,e,n="")=>{let a=Btn('切换',function(){let t=this.parentNode,n=t.parentNode.parentNode;WSFrame.frame=e,WSFrame.switch=this,localStorage.setItem('WSFrame',e),localStorage.setItem('WSSwitch',this.id),WSFrame.splice(0,WSFrame.length,...t.ws),n.getNext||(n=n.parentNode,WSFrame.push(...t.parentNode.firstChild.ws)),WSFrame.push({send(){WS.emit('data',{room:'bilibili,twitch',field:'f.next',data:n.getNext()})}}),WS.emit('data',{room:'bilibili,twitch',field:'frame',data:e})});return a.id=t.ctrl.id+e+n,a},TimerCtrl=()=>[WSSend(Btn('开始',function(){this.send()}),'timer',['start']),WSSend(Btn('暂停',function(){this.send()}),'timer',['pause']),WSSend(Btn('重置',function(){this.send()}),'timer',['reset']),WSSend(Btn('设置时间',function(){this.value=['setTime',prompt('输入时间（格式 00:37:38.45)')],this.value[1]&&!Number.isNaN(Time.toNumber(this.value[1]))&&this.send()}),'timer',1)],Trans=t=>Element('div').ap(Element('h4').txt('转场'),bind(Element('div'),t.ctrl,'data').ap(Btn('切换',function(){let t={};this.parentNode.ws.forEach(e=>{t[e.field]=e.value}),WS.emit('data',{room:'trans',field:'trans',data:t})}),Element('br'),Element('span').txt('时间:'),WSBind(t.ctrl,'start',t=>new Date(1e3*t).toTimeString().slice(0,5),'t.time','trans'),Element('span').txt('时长:'),WSBind(t.sub??t.ctrl,'est',Number,'t.est','trans'),Element('span').txt('流程:'),WSBind(t.sub??t.ctrl,'cat',0,'t.cat','trans'),Element('span').txt('分类:'),WSBind(t.sub??t.ctrl,'type',t=>['Solo Run','Standard Race','Blind Race','Co-op Run','Others','Special Event','Q&A'][Number(t)],'t.type','trans'),Element('br'),Element('span').txt('名称:'),WSSend(bindArr(Element('input'),'t.game',0,t.sub?t.sub.get('game').map(t=>t[0]).join(' + '):t.ctrl.get('name')),'t.game','','trans'),Element('span').txt('封面:'),WSSend(bindArr(Element('input'),'t.cover',0,''),'t.cover','','trans'),Element('span').txt('选手:'),WSSend(bindArr(Element('input'),'t.run',0,t.getRunner().map(t=>t.replace(/(\/\d+)|(\:.+)|(\>.+)/g,'')).join(', ')),'t.run','','trans'))),WSGame=t=>[Element('span').txt('名称:'),WSSend(bindArr(Element('input'),'f.game',0,t.sub?t.sub.get('game').map(t=>t[0]).join(' + '):t.ctrl.get('name')),'f.game'),Element('span').txt('封面:'),WSSend(bindArr(Element('input'),'f.cover',0,''),'f.cover',''),Element('span').txt('时长:'),WSBind(t.sub??t.ctrl,'est',Number,'f.est'),Element('span').txt('流程:'),WSBind(t.sub??t.ctrl,'cat',0,'f.cat')],WSRunner=(t,e,n="")=>{let a=WSSend(bindArr(Element('div'),'f.run'+n,0,t.getRunner().map(t=>t.replace(/(\/\d+)|(\:.+)|(\>.+)/g,''))),'f.run',0,n||'bilibili');for(let t=0;t<e;t++)a.ap(Element('span').txt((n?'T_':'B_')+(t+1)+':'),bindArr(Element('input'),t));return a},subGame=(t,e,n,a)=>[WSSend(bindArr(Element('input'),'rg'+t,0,e),'f.game'),Element('br'),Element('span').txt('流程:'),WSSend(bindArr(Element('input','inline'),'rgc'+t,0,n),'f.cat'),Element('span').txt('时长:'),WSSend(bindArr(Element('input','inline'),'rgt'+t,Number,a),'f.est')],Frame=t=>{let e=bind(Element('div'),t.ctrl,'data').ap(Element('h4').txt('框架'),bindArr(Element('select').ap(Element('option',0,{value:0}).txt('solo'),Element('option',0,{value:1}).txt('solo(16:9)'),Element('option',0,{value:2}).txt('race2'),Element('option',0,{value:3}).txt('race3'),Element('option',0,{value:4}).txt('race4'),Element('option',0,{value:5}).txt('race5'),Element('option',0,{value:6}).txt('接力赛'),Element('option',0,{value:7}).txt('跳刺锦标赛'),Element('option',0,{value:8}).txt('Q&A'),Element('option',0,{value:9}).txt('Music Quiz')),'frame',t=>Number(t),0,t=>{css($c('template',n),{display:''},t,{display:'block'})})),n=Element('div').ap(bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'solo'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,t.ctrl.get('sch').get('r').length)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'solow'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,t.ctrl.get('sch').get('r').length)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race2'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,2)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race3'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,3)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race4'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,4),WSRunner(t,4,'twitch')),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race5'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,5),WSRunner(t,5,'twitch')),Element('div','template').ap(bind(Element('div'),t.ctrl,'data').ap(...TimerCtrl(),Element('br'),Element('span').txt('封面:'),WSSend(bindArr(Element('input'),'f.cover',0,''),'f.cover','')),bind(Element('div'),t.ctrl,'data').ap(Element('span').txt('Game 1'),Switch(t,'relay',1),...subGame(1,'Relay Race - Alphazetica','Any%',20)),bind(Element('div'),t.ctrl,'data').ap(Element('span').txt('Game 2'),Switch(t,'relay',2),...subGame(2,'Relay Race - Not Another Needle Game','To Bad Ending%',40)),bind(Element('div'),t.ctrl,'data').ap(Element('span').txt('Game 3'),Switch(t,'relay',3),...subGame(3,'Relay Race - I Wanna Hydrate','Any%',25)),bind(Element('div'),t.ctrl,'data').ap(Element('span').txt('Game 4'),Switch(t,'relay',4),...subGame(4,'Relay Race - I Wanna Be The Blizzard','Any%',25)),bind(Element('div'),t.ctrl,'data').ap(Element('span').txt('Game 5'),Switch(t,'relay',5),...subGame(5,'Relay Race - I Wanna Be The Cloudburst','Any%',15))),bind(Element('div','template'),t.ctrl,'data').ap());return[e,n]};window.init=async()=>{let t=await new AV.Query('Control').include(['sub.run','sch']).limit(999).find({useMasterKey:!0});const e=$('list'),n=$('edit'),a=$('schedule'),l=[1628899200,1628985600,1629417600,1629504e3,1629590400],r=t=>{if(!t.ctrl.get('start'))return;if(t.sch)return updBind(t.ctrl,'start'),void a.ap(t.sch);let e=Element('div','sch');e.id=t.ctrl.id,bindUpd(e,t.ctrl,'start',(t,e)=>{let n=0;for(;n<l.length&&!(l[n]>e);n++);let a=(e-l[--n])/30;css(t,{left:20*n+'%',top:a/24+'%',zIndex:10+a})}),e.ap(bindUpd(Element('span','sch-time'),t.ctrl,'start',(t,e)=>t.txt(new Date(1e3*e).toTimeString().slice(0,5)+' - '))),t.sub?(bindUpd(e,t.sub,'est',(t,e)=>t.style.height=e/12+'%'),bindUpd(e,t.sub,'type',(t,e)=>t.className='sch s'+e),e.ap(bindUpd(Element('span','sch-game'),t.sub,'game',(t,e)=>t.txt(e.map(t=>t[0]).join(' + '))))):(bindUpd(e,t.ctrl,'est',(t,e)=>t.style.height=e/12+'%'),bindUpd(e,t.ctrl,'type',(t,e)=>t.className='sch s'+e),e.ap(bindUpd(Element('span','sch-game'),t.ctrl,'name',(t,e)=>t.txt(e)))),e.onmousedown=t=>{t.button?(e.ctrl.unset('start'),e.remove()):(a.drag=e,a.dragX=-a.parentNode.offsetLeft,a.dragY=e.offsetTop-t.y)},e.ondblclick=()=>{$c('now')[0]?.classList.remove('now'),e.classList.add('now'),t.onclick(),localStorage.setItem('currentRun',e.id)},t.sch=e,e.ctrl=t.ctrl,a.ap(e)};a.onmousemove=t=>{if(!a.drag)return;let e=Math.min(4,Math.max(0,(a.dragX+t.x)/a.offsetWidth*5<<0)),n=300*Math.max(0,(a.dragY+t.y)/a.offsetHeight*240<<0);updBind(a.drag.ctrl,'start',l[e]+n)},a.onmouseup=a.onmouseleave=()=>a.drag=null,a.oncontextmenu=t=>t.preventDefault();t.forEach(t=>{let a=(t=>{let a=Element('div','list');a.ctrl=t,a.sub=t.get('sub'),a.p=Element('div'),a.add=Element('div','add-sch'),a.getRunner=()=>a.ctrl.get('run')?a.ctrl.get('run').split(','):a.ctrl.get('sch').get('r');let i=a.sub??t;return a.ctrl.get('start')&&a.p.ap(Element('span').txt('时长:'),bind(Element('input','inline'),i,'est',t=>Number(t)),...a.sub?[bindUpd(Element('span'),a.sub,'cam',(t,e)=>t.txt(['有摄像头',''][e])),bindUpd(Element('span'),a.sub,'com',(t,e)=>t.txt(['有解说','无解说'][e])),bindUpd(Element('span'),a.sub,'comp',(t,e)=>t.txt(e?': '+e:''))]:[],Element('br'),Element('span').txt('分类:'),bind(Element('select').ap(Element('option',0,{value:0}).txt('Solo Run'),Element('option',0,{value:1}).txt('Standard Race'),Element('option',0,{value:2}).txt('Blind Race'),Element('option',0,{value:3}).txt('Co-op Run'),Element('option',0,{value:4}).txt('Others'),Element('option',0,{value:5}).txt('Special Event'),Element('option',0,{value:6}).txt('Q&A')),i,'type',t=>Number(t)),bind(Element('input','inline'),i,'cat'),...a.sub?[bindUpd(Element('span'),a.sub,'win',(t,e)=>t.txt(['4:3','16:9'][e]))]:[],Element('br'),Element('span').txt('选手:'),bind(Element('input'),t,'run',0,t.get('sch')?.get('r').join(',')),Trans(a),...Frame(a),a.add.txt('添加到时间表->')),a.add.onclick=()=>{t.get('start')||t.set('start',l[0]),r(a)},a.p.style.display='none',a.p.getNext=()=>{let t=null,e=1/0;if($c('list').forEach(n=>{let l=n.ctrl.get('start');l>a.ctrl.get('start')&&l<e&&(e=l,t=n)}),t)return t.sch.innerText.slice(0,8)+(t.ctrl.get('data').game??(t.sub?t.sub.get('game').map(t=>t[0]).join(' + '):t.ctrl.get('name')))},e.append(a),n.ap(a.p),a})(t);r(a),((t,e)=>{t.onclick=()=>{let n=$c('list-now')[0];n&&(n.classList.remove('list-now'),n.p.style.display='none'),t.classList.add('list-now'),t.p.style.display='',e?.()}})(a)});let i=localStorage.getItem('currentRun');if(i){let t=$(i);t&&(a.parentNode.scrollTo(0,t.offsetTop-200),t.ondblclick())}WSFrame.frame=localStorage.getItem('WSFrame'),WSFrame.switch=$(localStorage.getItem('WSSwitch')),WSFrame.switch&&setTimeout(()=>WSFrame.switch?.onclick(),1e3);const s=t=>{let e=t.get('name')||t.getUsername(),n=t.get('link');return n&&n.startsWith('http')?e+(t=>t.startsWith('https://space.bilibili.com')?t.slice(26):t.startsWith('https://www.twitch.tv/')?':'+t.slice(22):'>'+t)(n):e},m=t=>JSON.stringify(Object.entries(t._serverData).sort((t,e)=>t[0].localeCompare(e[0])))!==JSON.stringify(Object.entries(t.attributes).sort((t,e)=>t[0].localeCompare(e[0])));$('save-sch').onclick=()=>{let t=[],e=[];$c('list').forEach(n=>{if(n.ctrl)if(n.ctrl.get('start')){let e=n.ctrl.get('sch');e||(e=new AV.Object('FASF2021'),n.ctrl.set('sch',e));let a=n.sub??n.ctrl,l=a.get('cat'),r=a.get('type'),i=a.get('est');if(l&&'Any%'!==l&&e.set('c',l),e.set('t',['Solo Run','Standard Race','Blind Race','Co-op Run','Others','Special Event','Q&A'][r]),e.set('e',i),e.set('g',n.sub?a.get('game').map(t=>t[1]?t[0]+'='+t[1].replace('https://delicious-fruit.com/ratings/game_details.php?id=',''):t[0]):[a.get('name')]),e.set('r',n.ctrl.get('run')?n.getRunner():n.sub?a.get('run').map(s):n.getRunner()),e.set('s',new Date(1e3*n.ctrl.get('start'))),!m(e)&&!m(n.ctrl))return;t.push(n.ctrl)}else if(n.ctrl.get('sch')){if(!m(n.ctrl))return;e.push(n.ctrl.get('sch')),n.ctrl.unset('sch'),t.push(n.ctrl)}}),t.length?(console.log(t),AV.Object.destroyAll(e,{useMasterKey:!0}).then(()=>AV.Object.saveAll(t,{useMasterKey:!0})).then(()=>msg('保存成功')).catch(t=>{console.error(t),msg('保存失败',1)})):msg('已保存',2)}};