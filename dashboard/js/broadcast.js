const WS=io.connect(location.origin+'/frame?side=control'),WSFrame=[];WS.on('f.init',t=>{t!==WSFrame.frame&&WSFrame.switch?WSFrame.switch.onclick():WSFrame.forEach(t=>t.send())});const WSSend=(t,e,n,l="bilibili,twitch")=>(t.send=()=>{WS.emit('data',{room:l,field:e,data:t.value||n})},n||setTimeout(t=>{t.parentNode.ws||(t.parentNode.ws=[]),t.parentNode.ws.push(t)},10,t),t),Switch=(t,e,n="")=>{let l=Btn('切换',function(){let t=this.parentNode;WSFrame.frame=e,WSFrame.switch=this,localStorage.setItem('WSFrame',e),localStorage.setItem('WSSwitch',this.id),WSFrame.splice(0,WSFrame.length,...t.ws,{send(){WS.emit('data',{room:'bilibili,twitch',field:'f.next',data:t.parentNode.parentNode.getNext()})}}),WS.emit('data',{room:'bilibili,twitch',field:'frame',data:e})});return l.id=t.ctrl.id+e+n,l},TimerCtrl=()=>[WSSend(Btn('开始',function(){this.send()}),'timer',['start']),WSSend(Btn('暂停',function(){this.send()}),'timer',['pause']),WSSend(Btn('重置',function(){this.send()}),'timer',['reset']),WSSend(Btn('设置时间',function(){this.value=['setTime',prompt('输入时间（格式 00:37:38.45)')],this.value[1]&&!Number.isNaN(Time.toNumber(this.value[1]))&&this.send()}),'timer',1)],Trans=t=>Element('div').ap(Element('h4').txt('转场'),bind(Element('div'),t.ctrl,'data').ap(Element('span').txt('名称:'),bindArr(Element('input'),'t.game',0,t.sub?t.sub.get('game').map(t=>t[0]).join(' + '):t.ctrl.get('name')),Element('span').txt('封面:'),bindArr(Element('input'),'t.cover',0,''))),WSGame=t=>[Element('span').txt('名称:'),WSSend(bindArr(Element('input'),'f.game',0,t.sub?t.sub.get('game').map(t=>t[0]).join(' + '):t.ctrl.get('name')),'f.game'),Element('span').txt('封面:'),WSSend(bindArr(Element('input'),'f.cover',0,''),'f.cover',''),Element('span').txt('时长:'),WSSend(bindArr(Element('input'),'f.est',Number,(t.sub??t.ctrl).get('est')),'f.est'),Element('span').txt('流程:'),WSSend(bindArr(Element('input'),'f.cat',0,(t.sub??t.ctrl).get('cat')),'f.cat')],WSRunner=(t,e,n="")=>{let l=WSSend(bindArr(Element('div'),'f.run'+n,0,t.getRunner().map(t=>t.replace(/(\/\d+)|(\:.+)|(\>.+)/g,''))),'f.run',0,n||'bilibili');for(let t=0;t<e;t++)l.ap(Element('span').txt((n?'T_':'B_')+(t+1)+':'),bindArr(Element('input'),t));return l},Frame=t=>{let e=bind(Element('div'),t.ctrl,'data').ap(Element('h4').txt('框架'),bindArr(Element('select').ap(Element('option',0,{value:0}).txt('solo'),Element('option',0,{value:1}).txt('solo(16:9)'),Element('option',0,{value:2}).txt('race2'),Element('option',0,{value:3}).txt('race3'),Element('option',0,{value:4}).txt('race4'),Element('option',0,{value:5}).txt('race5'),Element('option',0,{value:6}).txt('接力赛'),Element('option',0,{value:7}).txt('跳刺锦标赛'),Element('option',0,{value:8}).txt('Q&A'),Element('option',0,{value:9}).txt('Music Quiz')),'frame',t=>Number(t),0,t=>{css($c('template',e),{display:''},t,{display:'block'})}),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'solo'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,t.ctrl.get('sch').get('r').length)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'solow'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,t.ctrl.get('sch').get('r').length)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race2'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,2)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race3'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,3)),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race4'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,4),WSRunner(t,4,'twitch')),bind(Element('div','template'),t.ctrl,'data').ap(Switch(t,'race5'),...TimerCtrl(),Element('br'),...WSGame(t),WSRunner(t,5),WSRunner(t,5,'twitch')));return e};window.init=async()=>{let t=await new AV.Query('Control').include(['sub.run','sch']).limit(999).find({useMasterKey:!0});const e=$('list'),n=$('edit'),l=$('schedule'),a=[1628899200,1628985600,1629417600,1629504e3,1629590400],r=t=>{if(!t.ctrl.get('start'))return;if(t.sch)return updBind(t.ctrl,'start'),void l.ap(t.sch);let e=Element('div','sch');e.id=t.ctrl.id,bindUpd(e,t.ctrl,'start',(t,e)=>{let n=0;for(;n<a.length&&!(a[n]>e);n++);let l=(e-a[--n])/30;css(t,{left:20*n+'%',top:l/24+'%',zIndex:10+l})}),e.ap(bindUpd(Element('span','sch-time'),t.ctrl,'start',(t,e)=>t.txt(new Date(1e3*e).toTimeString().slice(0,5)+' - '))),t.sub?(bindUpd(e,t.sub,'est',(t,e)=>t.style.height=e/12+'%'),bindUpd(e,t.sub,'type',(t,e)=>t.className='sch s'+e),e.ap(bindUpd(Element('span','sch-game'),t.sub,'game',(t,e)=>t.txt(e.map(t=>t[0]).join(' + '))))):(bindUpd(e,t.ctrl,'est',(t,e)=>t.style.height=e/12+'%'),bindUpd(e,t.ctrl,'type',(t,e)=>t.className='sch s'+e),e.ap(bindUpd(Element('span','sch-game'),t.ctrl,'name',(t,e)=>t.txt(e)))),e.onmousedown=t=>{t.button?(e.ctrl.unset('start'),e.remove()):(l.drag=e,l.dragX=-l.parentNode.offsetLeft,l.dragY=e.offsetTop-t.y)},e.ondblclick=()=>{$c('now')[0]?.classList.remove('now'),e.classList.add('now'),t.onclick(),localStorage.setItem('currentRun',e.id)},t.sch=e,e.ctrl=t.ctrl,l.ap(e)};l.onmousemove=t=>{if(!l.drag)return;let e=Math.min(4,Math.max(0,(l.dragX+t.x)/l.offsetWidth*5<<0)),n=300*Math.max(0,(l.dragY+t.y)/l.offsetHeight*240<<0);updBind(l.drag.ctrl,'start',a[e]+n)},l.onmouseup=l.onmouseleave=()=>l.drag=null,l.oncontextmenu=t=>t.preventDefault();t.forEach(t=>{let l=(t=>{let l=Element('div','list');l.ctrl=t,l.sub=t.get('sub'),l.p=Element('div'),l.add=Element('div','add-sch'),l.getRunner=()=>l.ctrl.get('run')?l.ctrl.get('run').split(','):l.ctrl.get('sch').get('r');let i=l.sub??t;return l.ctrl.get('start')&&l.p.ap(Element('span').txt('时长:'),bind(Element('input','inline'),i,'est',t=>Number(t)),...l.sub?[bindUpd(Element('span'),l.sub,'cam',(t,e)=>t.txt(['有摄像头',''][e])),bindUpd(Element('span'),l.sub,'com',(t,e)=>t.txt(['有解说','无解说'][e])),bindUpd(Element('span'),l.sub,'comp',(t,e)=>t.txt(e?': '+e:''))]:[],Element('br'),Element('span').txt('分类:'),bind(Element('select').ap(Element('option',0,{value:0}).txt('Solo Run'),Element('option',0,{value:1}).txt('Standard Race'),Element('option',0,{value:2}).txt('Blind Race'),Element('option',0,{value:3}).txt('Co-op Run'),Element('option',0,{value:4}).txt('Others'),Element('option',0,{value:5}).txt('Special Event'),Element('option',0,{value:6}).txt('Q&A')),i,'type',t=>Number(t)),bind(Element('input','inline'),i,'cat'),...l.sub?[bindUpd(Element('span'),l.sub,'win',(t,e)=>t.txt(['4:3','16:9'][e]))]:[],Element('br'),Element('span').txt('选手:'),bind(Element('input'),t,'run',0,t.get('sch')?.get('r').join(',')),Trans(l),Frame(l),l.add.txt('添加到时间表->')),l.add.onclick=()=>{t.get('start')||t.set('start',a[0]),r(l)},l.p.style.display='none',l.p.getNext=()=>{let t=null,e=1/0;if($c('list').forEach(n=>{let a=n.ctrl.get('start');a>l.ctrl.get('start')&&a<e&&(e=a,t=n)}),t)return t.sch.innerText.slice(0,8)+(t.ctrl.get('data').game??(t.sub?t.sub.get('game').map(t=>t[0]).join(' + '):t.ctrl.get('name')))},e.append(l),n.ap(l.p),l})(t);r(l),((t,e)=>{t.onclick=()=>{let n=$c('list-now')[0];n&&(n.classList.remove('list-now'),n.p.style.display='none'),t.classList.add('list-now'),t.p.style.display='',e?.()}})(l)});let i=localStorage.getItem('currentRun');if(i){let t=$(i);t&&(l.parentNode.scrollTo(0,t.offsetTop-200),t.ondblclick())}WSFrame.frame=localStorage.getItem('WSFrame'),WSFrame.switch=$(localStorage.getItem('WSSwitch')),WSFrame.switch&&setTimeout(()=>WSFrame.switch?.onclick(),1e3);const s=t=>{let e=t.get('name')||t.getUsername(),n=t.get('link');return n&&n.startsWith('http')?e+(t=>t.startsWith('https://space.bilibili.com')?t.slice(26):t.startsWith('https://www.twitch.tv/')?':'+t.slice(22):'>'+t)(n):e},c=t=>JSON.stringify(Object.entries(t._serverData).sort((t,e)=>t[0].localeCompare(e[0])))!==JSON.stringify(Object.entries(t.attributes).sort((t,e)=>t[0].localeCompare(e[0])));$('save-sch').onclick=()=>{let t=[],e=[];$c('list').forEach(n=>{if(n.ctrl)if(n.ctrl.get('start')){let e=n.ctrl.get('sch');e||(e=new AV.Object('FASF2021'),n.ctrl.set('sch',e));let l=n.sub??n.ctrl,a=l.get('cat'),r=l.get('type'),i=l.get('est');if(a&&'Any%'!==a&&e.set('c',a),e.set('t',['Solo Run','Standard Race','Blind Race','Co-op Run','Others','Special Event','Q&A'][r]),e.set('e',i),e.set('g',n.sub?l.get('game').map(t=>t[1]?t[0]+'='+t[1].replace('https://delicious-fruit.com/ratings/game_details.php?id=',''):t[0]):[l.get('name')]),e.set('r',n.ctrl.get('run')?n.getRunner():n.sub?l.get('run').map(s):n.getRunner()),e.set('s',new Date(1e3*n.ctrl.get('start'))),!c(e)&&!c(n.ctrl))return;t.push(n.ctrl)}else if(n.ctrl.get('sch')){if(!c(n.ctrl))return;e.push(n.ctrl.get('sch')),n.ctrl.unset('sch'),t.push(n.ctrl)}}),t.length?(console.log(t),AV.Object.destroyAll(e,{useMasterKey:!0}).then(()=>AV.Object.saveAll(t,{useMasterKey:!0})).then(()=>msg('保存成功')).catch(t=>{console.error(t),msg('保存失败',1)})):msg('已保存',2)}};