const Parser={token(e,t){let r='';for(let e in this.syntax)r+=`(${this.syntax[e].source})|`;r+='(\\w+)|(.)';let l=e.match(new RegExp(r,'g'));if(!l)return;let n=[],i=1,o=0;for(let e=0;e<l.length;e++){let r,a=l[e];'\n'===a?(i++,o=0):o+=a.length;for(let e in this.syntax)if(this.syntax[e].test(a)){r={value:a,type:e,line:i,position:o,i:n.length},(t||'Space'!==e)&&n.push(r);break}r||(this.error({line:i,position:o},'语法错误',!t),t&&n.push({value:a,type:'Error',line:i,position:o}))}return n.line=i,n}},JSONParser={syntax:{Key:/"[^\n"]+":/,String:/"[^\n"]*"(?!\s*:)/,Number:/-?\b\d+(\.\d+)?\b/,Bracket:/[\[\]]/,Brace:/[\{\}]/,ValSep:/,/,Space:/\s/},error(e,t,r=!0){if(r)throw[e.line,e.position,t]},token:Parser.token,parse(e,t){if(!e)return;let r=0;const l=()=>{for(;;){let t=e[r];if(t){if(']'===t.value){r++;break}if('Key'===t.type||'ValSep'===t.type||'}'===t.value)this.error(t,'语法错误');else if(i(),t=e[r],t||this.error(e[r-1],'语法错误'),'ValSep'===t.type){let l=e[r+1];l||this.error(t,'语法错误'),']'===l.value&&this.error(t,'语法错误'),r++}else']'!==t.value&&this.error(t,'语法错误')}else this.error(e[r-1],'语法错误')}},n=()=>{for(;;){let t=e[r];if(t){if('}'===t.value){r++;break}if('Key'===t.type)if(r++,i(),t=e[r],t||this.error(e[r-1],'语法错误'),'ValSep'===t.type){let l=e[r+1];l||this.error(t,'语法错误'),'}'===l.value&&this.error(t,'语法错误'),r++}else'}'!==t.value&&this.error(t,'语法错误');else this.error(e[r],'语法错误')}else this.error(e[r-1],'语法错误')}},i=()=>{let t=e[r];t||this.error(e[r-1],'语法错误'),r++,'['===t.value?l():'{'===t.value?n():'Number'!==t.type&&'String'!==t.type&&this.error(t,'语法错误')};let o=e[r];o&&(r++,t?('['!==o.value&&this.error(o,'语法错误'),l(),e[r]&&this.error(e[r],'语法错误')):('{'!==o.value&&this.error(o,'语法错误'),n(),e[r]&&this.error(e[r],'语法错误')))}},HTMLParser={syntax:{Key:/<\/?\w+( \w+='[^']*')*\/?>/,Text:/[^<]+/},token:Parser.token,parse(){}},codeBox=(e,t,r)=>{let l=Element('div','code-text'),n=Element('div','code-side').ap(Element('div')),i=Element('div','code-box').ap(Element('div','code-area').ap(Element('div','code').ap(n,e,l)),Element('div','code-bottom').ap(css(Element('span'),{color:'#f00'})));return e.onkeydown=e=>{if('Tab'===e.key){e.preventDefault();let t=e.target,r=t.selectionStart,l=t.selectionEnd;if(e.shiftKey){t.value=t.value.slice(0,r)+t.value.slice(r,l).replace(/(\n  )|(\n )/g,'\n')+t.value.slice(l);for(let e=0;e<2&&' '===t.value[0];e++)t.value=t.value.slice(1),r--;t.selectionStart=t.selectionEnd=r}else t.value=t.value.slice(0,r)+'  '+t.value.slice(r,l).replace(/\n/g,'\n  ')+t.value.slice(l),t.selectionStart=t.selectionEnd=r+2;t.oninput()}},e.oninput=()=>{let i=e;clearTimeout(i.check),i.value=i.value.replace(/\t/g,'  ').replace(/\r/g,'');let o=t.token(i.value,1);n.innerHTML='';let a=1;o&&o.line&&(a=o.line);for(let e=0;e<a;e++){let t=document.createElement('div');t.id='line'+(e+1),n.append(t)}l.innerHTML='';let s=i.parentNode.parentNode.nextSibling.firstChild;s.innerText='',o&&(o.forEach(e=>{if('\n'===e.value){let t=document.createElement('br');t.id=e.line+','+e.position,l.append(t)}else{let t=document.createElement('span');t.className='code-'+e.type,"Error"===e.type&&(s.innerText=`行${e.line} 位置${e.position}: 语法错误`,document.getElementById('line'+e.line).style.background='#f002'),t.id=e.line+','+e.position,t.innerText=e.value,l.append(t)}}),l.offsetWidth&&(e.style.width=l.offsetWidth+'px'),i.check=setTimeout(e=>{try{t.parse(t.token(e.value),r)}catch(e){3===e.length&&(document.getElementById(e[0]+','+e[1]).className+=' code-Error',s.innerText=`行${e[0]} 位置${e[1]}: ${e[2]}`,document.getElementById('line'+e[0]).style.background='#f002')}},500,i))},i};